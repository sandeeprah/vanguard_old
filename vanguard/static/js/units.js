unitLib = {

    "length": {
        "dimtitle": "Length",
        "units": {
            "um": {
                "label": "μm",
                "cf": 1e-6,
                "off": 0
            },
            "mm": {
                "label": "mm",
                "cf": 1e-3,
                "off": 0
            },
            "m": {
                "label": "m",
                "cf": 1,
                "off": 0
            },
            "ft": {
                "label": "ft",
                "cf": 0.3048,
                "off": 0
            },
            "yd": {
                "label": "yd",
                "cf": 0.9144,
                "off": 0
            }
        }
    },

    "length_micro": {
        "dimtitle": "Length Micro",
        "units": {
            "um": {
                "label": "μm",
                "cf": 1e-6,
                "off": 0
            },
            "mm": {
                "label": "mm",
                "cf": 1e-3,
                "off": 0
            },
            "m": {
                "label": "m",
                "cf": 1,
                "off": 0
            },
            "ft": {
                "label": "ft",
                "cf": 0.3048,
                "off": 0
            },
            "yd": {
                "label": "yd",
                "cf": 0.9144,
                "off": 0
            }
        }
    },

    "length_mili": {
        "dimtitle": "Length Mili",
        "units": {
            "um": {
                "label": "μm",
                "cf": 1e-6,
                "off": 0
            },
            "mm": {
                "label": "mm",
                "cf": 1e-3,
                "off": 0
            },
            "m": {
                "label": "m",
                "cf": 1,
                "off": 0
            },
            "ft": {
                "label": "ft",
                "cf": 0.3048,
                "off": 0
            },
            "yd": {
                "label": "yd",
                "cf": 0.9144,
                "off": 0
            }
        }
    },

    "length_kilo": {
        "dimtitle": "Length Kilo",
        "units": {
            "um": {
                "label": "μm",
                "cf": 1e-6,
                "off": 0
            },
            "mm": {
                "label": "mm",
                "cf": 1e-3,
                "off": 0
            },
            "m": {
                "label": "m",
                "cf": 1,
                "off": 0
            },
            "ft": {
                "label": "ft",
                "cf": 0.3048,
                "off": 0
            },
            "yd": {
                "label": "yd",
                "cf": 0.9144,
                "off": 0
            }
        }
    },
    "area": {
        "dimtitle": "Area",
        "units": {
            "m2": {
                "label": "m²",
                "cf": 1,
                "off": 0
            },
            "mm2": {
                "label": "mm²",
                "cf": 1e-6,
                "off": 0
            },
            "ft2": {
                "label": "ft²",
                "cf": 0.092903,
                "off": 0
            },
            "in2": {
                "label": "in²",
                "cf": 6.4516e-4,
                "off": 0
            }
        }
    },

    "volume": {
        "dimtitle": "Volume",
        "units": {
            "m3": {
                "label": "m³",
                "cf": 1,
                "off": 0
            },
            "ft3": {
                "label": "ft³",
                "cf": 0.0283168,
                "off": 0
            }
        }
    },

    "angle": {
        "dimtitle": "Angle",
        "units": {
            "degrees": {
                "label": "degrees",
                "cf": 1.74533e-2,
                "off": 0
            },
            "radians": {
                "label": "radians",
                "cf": 1,
                "off": 0
            }
        }
    },

    "mass": {
        "dimtitle": "Mass",
        "units": {
            "ug": {
                "label": "μg",
                "cf": 1e-9,
                "off": 0
            },
            "mg": {
                "label": "mg",
                "cf": 1e-6,
                "off": 0
            },
            "g": {
                "label": "g",
                "cf": 1e-3,
                "off": 0
            },
            "kg": {
                "label": "kg",
                "cf": 1,
                "off": 0
            },
            "ton": {
                "label": "ton",
                "cf": 1e3,
                "off": 0
            },
            "lb": {
                "label": "lb",
                "cf": 0.453592,
                "off": 0
            }
        }
    },
    "time": {
        "dimtitle": "Time",
        "units": {
            "us": {
                "label": "μs",
                "cf": 1e-6,
                "off": 0
            },
            "ms": {
                "label": "ms",
                "cf": 1e-3,
                "off": 0
            },
            "s": {
                "label": "μs",
                "cf": 1,
                "off": 0
            },
            "min": {
                "label": "min",
                "cf": 60,
                "off": 0
            },
            "hr": {
                "label": "hr",
                "cf": 3600,
                "off": 0
            },
            "day": {
                "label": "day",
                "cf": 86400,
                "off": 0
            }
        }
    },
    "speed": {
        "dimtitle": "Speed",
        "units": {
            "m/s": {
                "label": "m/s",
                "cf": 1,
                "off": 0
            },
            "km/hr": {
                "label": "km/hr",
                "cf": 0.277778,
                "off": 0
            },
            "ft/s": {
                "label": "ft/s",
                "cf": 0.3048,
                "off": 0
            }
        }
    },
    "acceleration": {
        "dimtitle": "Acceleration",
        "units": {
            "m/s2": {
                "label": "m/s²",
                "cf": 1,
                "off": 0
            },
            "ft/s2": {
                "label": "ft/s²",
                "cf": 0.3048,
                "off": 0
            }
        }
    },

    "force": {
        "dimtitle": "Force",
        "units": {
            "N": {
                "label": "N",
                "cf": 1,
                "off": 0
            },
            "kN": {
                "label": "kN",
                "cf": 1e3,
                "off": 0
            },
            "lbf": {
                "label": "lbf",
                "cf": 4.44822,
                "off": 0
            }
        }
    },

    "energy": {
        "dimtitle": "Energy",
        "units": {
            "J": {
                "label": "J",
                "cf": 1,
                "off": 0
            },
            "kJ": {
                "label": "kJ",
                "cf": 1e3,
                "off": 0
            },
            "Btu": {
                "label": "Btu",
                "cf": 1055.06,
                "off": 0
            }
        }
    },

    "power": {
        "dimtitle": "Power",
        "units": {
            "W": {
                "label": "W",
                "cf": 1,
                "off": 0
            },
            "kW": {
                "label": "kW",
                "cf": 1e3,
                "off": 0
            },
            "hp": {
                "label": "hp",
                "cf": 746,
                "off": 0
            }
        }
    },

    "pressure": {
        "dimtitle": "Pressure",
        "units": {
            "Pa": {
                "label": "Pa",
                "cf": 1,
                "off": 0
            },
            "kPa": {
                "label": "kPa",
                "cf": 1e3,
                "off": 0
            },
            "MPa": {
                "label": "MPa",
                "cf": 1e6,
                "off": 0
            },
            "bar": {
                "label": "bar",
                "cf": 1e5,
                "off": 0
            },
            "atm": {
                "label": "atm",
                "cf": 101325,
                "off": 0
            },
            "kg/cm2": {
                "label": "kg/cm²",
                "cf": 98066.5,
                "off": 0
            }
        }
    },

    "temperature": {
        "dimtitle": "Temperature",
        "units": {
            "K": {
                "label": "K",
                "cf": 1,
                "off": 0
            },
            "C": {
                "label": "°C",
                "cf": 1,
                "off": 273.15
            },
            "F": {
                "label": "°F",
                "cf": 5 / 9,
                "off": -32 * 5 / 9 + 273.15,
            },
            "R": {
                "label": "°R",
                "cf": 5 / 9,
                "off": 0
            }
        }
    },

    "massflow": {
        "dimtitle": "Mass Flow",
        "units": {
            "kg/s": {
                "label": "kg/s",
                "cf": 1,
                "off": 0
            },
            "kg/min": {
                "label": "kg/min",
                "cf": 1 / 60,
                "off": 0
            },
            "kg/hr": {
                "label": "kg/hr",
                "cf": 1 / 3600,
                "off": 0
            },
            "lb/hr": {
                "label": "lb/hr",
                "cf": 1.25998e-4,
                "off": 0
            },
        }
    },


    "flow": {
        "dimtitle": "Flow",
        "units": {
            "m3/s": {
                "label": "m³/s",
                "cf": 1,
                "off": 0
            },
            "m3/min": {
                "label": "m³/min",
                "cf": 1 / 60,
                "off": 0
            },
            "m3/hr": {
                "label": "m³/hr",
                "cf": 1 / 3600,
                "off": 0
            },
            "lpm": {
                "label": "lpm",
                "cf": 1.6667e-5,
                "off": 0
            },
            "lph": {
                "label": "lph",
                "cf": 1e-3/3.6e3,
                "off": 0
            },
            "usgpm": {
                "label": "usgpm",
                "cf": 6.309e-5,
                "off": 0
            },
            "bbl/day": {
                "label": "bbl/day",
                "cf": 1.840e-6,
                "off": 0
            },
        }
    },

    "density": {
        "dimtitle": "Density",
        "units": {
            "kg/m3": {
                "label": "kg/m³",
                "cf": 1,
                "off": 0
            },
            "g/cm3": {
                "label": "g/cm³",
                "cf": 1e3,
                "off": 0
            },
            "lb/ft3": {
                "label": "lb/ft³",
                "cf": 16.018,
                "off": 0
            }
        }
    },
    "molecularMass":{
        "dimtitle":"Molecular Mass",
        "units":{
            "kg/mol" : {
                "label" : "kg/mol",
                "cf" : 1,
                "off" : 0
            },
            "g/mol" : {
                "label" : "g/mol",
                "cf" : 0.001,
                "off" : 0
            },
            "kg/kmol" : {
                "label" : "g/mol",
                "cf" : 0.001,
                "off" : 0
            }
        }
    },

    "specificVolume":{
        "dimtitle":"Specific Volume",
        "units":{
            "m3/kg" : {
                "label" : "m³/kg",
                "cf" : 1,
                "off" : 0
            }
        }
    },
    "specificEnergy":{
        "dimtitle":"Specific Energy",
        "units":{
            "J/kg" : {
                "label" : "J/kg",
                "cf" : 1,
                "off" : 0
            },
            "kJ/kg" : {
                "label" : "kJ/kg",
                "cf" : 1000,
                "off" : 0
            }
        }
    },
    "specificEnergyMolar":{
        "dimtitle":"Specific Energy Molar",
        "units":{
            "J/mol" : {
                "label" : "J/mol",
                "cf" : 1,
                "off" : 0
            },
            "kJ/kmol" : {
                "label" : "kJ/kmol",
                "cf" : 1,
                "off" : 0
            }
        }
    },
    "specificHeat":{
        "dimtitle":"Specific Heat",
        "units":{
            "J/kg.K" : {
                "label" : "J/kg.K",
                "cf" : 1,
                "off" : 0
            },
            "kJ/kg.K" : {
                "label" : "kJ/kg.K",
                "cf" : 1000,
                "off" : 0
            }
        }
    },

    "specificHeatMolar":{
        "dimtitle":"Molar Specific Heat",
        "units":{
            "J/mol.K" : {
                "label" : "J/mol.K",
                "cf" : 1,
                "off" : 0
            },
            "kJ/kmol.K" : {
                "label" : "kJ/kmol.K",
                "cf" : 1,
                "off" : 0
            }
        }
    },


    "thermalConductivity":{
        "dimtitle":"Thermal Conductivity",
        "units":{
            "W/m.K" : {
                "label" : "W/m.K",
                "cf" : 1,
                "off" : 0
            }
        }
    },

    "dynViscosity": {
        "dimtitle": "Dynamic Viscosity",
        "units": {
            "Pa.s": {
                "label": "Pa.s",
                "cf": 1,
                "off": 0
            },
            "mPa.s": {
                "label": "mPa.s",
                "cf": 1e-3,
                "off": 0
            },
            "cP": {
                "label": "cP",
                "cf": 1e-3,
                "off": 0
            },

        }
    },

    "kinViscosity": {
        "dimtitle": "Kinematic Viscosity",
        "units": {
            "m2/s": {
                "label": "m²/s",
                "cf": 1,
                "off": 0
            },
            "St": {
                "label": "St",
                "cf": 1e-4,
                "off": 0
            },
            "cSt": {
                "label": "cSt",
                "cf": 1e-6,
                "off": 0
            }
        }
    },

    "specificFuelConsumption" : {
        "dimtitle": "Specific Fuel Consumption",
        "units": {
            "m3/W.s": {
                "label": "m³/W.s",
                "cf": 1,
                "off": 0
            },
            "litre/kW.h": {
                "label": "litre/kW.h",
                "cf": 1e-6/3600,
                "off": 0
            }
        }
    },
    "intensity" : {
        "dimtitle": "Energy Intensity",
        "units": {
            "W/m2": {
                "label": "W/m²",
                "cf": 1,
                "off": 0
            },
            "kW/m2": {
                "label": "kW/m²",
                "cf": 1000,
                "off": 0
            }
        }
    }
}

SI_UNITS = {
  "length": "m",
  "length_micro": "m",
  "length_mili": "m",
  "length_kilo": "m",
  "area": "m2",
  "angle": "radians",
  "mass": "kg",
  "time": "s",
  "speed": "m/s",
  "acceleration": "m/s2",
  "force": "N",
  "energy": "J",
  "power": "W",
  "pressure": "Pa",
  "temperature": "K",
  "flow": "m3/s",
  "massflow": "kg/s",
  "density": "kg/m3",
  "molecularMass": "kg/mol",
  "specificVolume": "m3/kg",
  "specificEnergy": "J/kg",
  "specificEnergyMolar": "J/mol",
  "specificHeat": "J/kg.K",
  "specificHeatMolar": "J/mol.K",
  "thermalConductivity": "W/m.K",
  "dynViscosity": "Pa.s",
  "kinViscosity": "m2/s",
  "specificFuelConsumption" : "m3/W.s",
  "intensity" : "W/m2"

}


function getDimensions() {
    dimensions_list = []
    for (var dimension in unitLib) {
        if (unitLib.hasOwnProperty(dimension)) {
            dimensions_list.push(dimension);
        }
    }
    return dimensions_list;
}

function getDimensionTitle(dimension) {
    return unitLib[dimension]['dimtitle']
}

function getUnits(dimension) {
    units = unitLib[dimension]['units'];
    units_list = []
    for (var unit in units) {
        if (units.hasOwnProperty(unit)) {
            unit_item = {
                "unit": unit,
                "label": units[unit]['label']
            }
            units_list.push(unit_item);
        }
    }
    return units_list;
}

function getUnitLabel(dimension, unit) {
    return unitLib[dimension]["units"][unit]['label'];
}

function getUnitConvFact(dimension, unit) {
    ucf = 1;
    ucf = unitLib[dimension]["units"][unit]["cf"];
    return ucf;
}

function getUnitOffset(dimension, unit) {
    off = 0;
    off = unitLib[dimension]["units"][unit]["off"];
    return off;
}

function getSI_unit(dimension) {
    return SI_UNITS[dimension]
}

function round(value, decimals) {
    return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals).toFixed(decimals);
}

function unitConvert(value, dimension, fromUnit, toUnit) {
    if (isNaN(parseFloat(value))){
        return_value = value;
    }
    else{
        if ((fromUnit == 'none') || (toUnit=='none')) {
            return_value = value;
        }
        if (fromUnit == toUnit) {
            return_value = value;
        }
        else{
            parsed_value = parseFloat(value);
            cf_from_unit = getUnitConvFact(dimension, fromUnit);
            offset_from_unit = getUnitOffset(dimension, fromUnit);
            cf_to_unit = getUnitConvFact(dimension, toUnit);
            offset_to_unit = getUnitOffset(dimension, toUnit);
            base_value = parsed_value * cf_from_unit + offset_from_unit;
            return_value = (base_value - offset_to_unit) / cf_to_unit;
            return_value = roundit(return_value, 0.001, 6);
        }
    }
    return return_value;
}


function roundit(value, allowed_error, max_decims){
  if (value==0){
    return 0
  }
  else{
    for (var decims = 1; decims <= max_decims; decims++) {
      rounded_value = round(value, decims);
      abs_error = Math.abs(value-rounded_value);
      rel_error = abs_error/Math.abs(value);
      if (rel_error < allowed_error){
        return rounded_value;
      }
    }
  }
}

function round(value, decimals) {
  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
}


function treeUnitConvert(objecttree, fromUnits, toUnits) {
  for (var node in objecttree) {
      if (objecttree.hasOwnProperty(node)) {
          elem = objecttree[node];
          if (elem.hasOwnProperty('_dim') && elem.hasOwnProperty('_val')) {
              try {
                  var from_value = elem['_val'];
                  var dimension = elem['_dim'];
                  var from_unit;
                  var to_unit;
                  if (dimension != 'none') {
                      from_unit = fromUnits[dimension];
                      to_unit = toUnits[dimension];
                  } else {
                      from_unit = 'none';
                      to_unit = 'none';
                  }
                  var to_value = unitConvert(from_value, dimension, from_unit, to_unit);
                  elem['_val'] = to_value;
              } catch (err) {
                  elem['_val'] = '';
                  console.log(err);
                  console.log("error occured in unit convert while converting " + dimension)
              }
          } else if (elem.hasOwnProperty('_coldim') && elem.hasOwnProperty('_list')) {
              var index;
              var row;
              for (index = 0; index < elem['_list'].length; ++index) {
                  row = elem['_list'][index];
                  for (var column in row) {
                      if (row.hasOwnProperty(column)) {
                          console.log(column);
                          var from_value = row[column];
                          var dimension;
                          if (elem['_coldim'].hasOwnProperty(column)) {
                              dimension = elem['_coldim'][column]
                          } else {
                              dimension = 'none'
                          }
                          var from_unit;
                          var to_unit;
                          if (dimension != 'none') {
                              from_unit = fromUnits[dimension];
                              to_unit = toUnits[dimension];
                          } else {
                              from_unit = 'none';
                              to_unit = 'none';
                          }
                          var to_value = unitConvert(from_value, dimension, from_unit, to_unit);
                          row[column] = to_value;
                      }
                  }
              }

          } else {
              if (elem !== null && typeof(elem) === 'object') {
                  this.treeUnitConvert(elem, fromUnits, toUnits);
              }
          }
      }
  }
}
